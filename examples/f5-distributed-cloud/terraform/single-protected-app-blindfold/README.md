# Introduction
This Terraform example uses a bash script to create or update an HTTP Load Balancer with Custom Cetificate using Blindfold secret generated by the vesctl utility (https://docs.cloud.f5.com/docs/how-to/volterra-automation-tools/vesctl).

## Use cases:
- Create an HTTP Load Balancer using an Blindfold Secret based on the private key without exposing it in clear text.
- Update HTTP Load Balancer expired certificates using blindfold secret

## Objects created:
- Health check
- Origin Pool  
- App Firewall  
- HTTPS Load Balancer with Custom Certificate and encrypted private key using blindfold  

## Environment praparation:

- Generate the API Certificate and download it: 
  https://docs.cloud.f5.com/docs/how-to/user-mgmt/credentials/#generate-api-certificate
  Copy the .p12 file to certs/ folder

- Install and configure vesctl utility: https://gitlab.com/volterra.io/vesctl/-/tree/main

- Create .vesconfig config file in scripts/ folder with the location of the certificate and api endpoint url:
  server-urls: https://<tenant_name>.console.ves.volterra.io/api
  p12-bundle: /path/to/api_credential.p12

- Download the blindfold script and move it to scrips/ folder.

- Define the following variables in variables.tf
    "api_cred" = { default = "./certs/<api certificate name>.p12" }
    "api_url" = { default = "https://<tenant_name>.console.ves.volterra.io/api" }
    "namespace" = { default = <"The namespace where the application will be deployed"> }
    "app_domain" = { default = <"Application/Load balancer Domain name"> }
    "origin_server_dns" = { default = <"Public DNS Name of Origin Server"> }

- Copy the application Load Balancer's Certificate and private key in PEM format (Including the PEM headers) to the certs/ folder. 
- Create this environment variable and assign it your API credentials password: export VES_P12_PASSWORD=<credential password>

## Usage 
terraform init
terraform plan -var="lb_cert=./certs/<http load balancer certificate>" -var="lb_key=./certs/<http load balancer private key>"
terraform apply -var="lb_cert=./certs/<http load balancer certificate>" -var="lb_key=./certs/<http load balancer private key>"
terraform destroy -var="lb_cert=./certs/<http load balancer certificate>" -var="lb_key=./certs/<http load balancer private key>"

## Notes  
- F5 Distributed Cloud Blindfold reference: https://docs.cloud.f5.com/docs/how-to/advanced-security/blindfold-your-tls-certificates  
